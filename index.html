<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#E86C28">
    <title>Defesa Civil - Relatório de Vistoria</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #1a1a2e;
            line-height: 1.5;
            padding-bottom: 100px;
        }

        .header {
            background: #E86C28;
            color: white;
            padding: 20px 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #E86C28;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #E86C28;
        }

        .row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .row > * {
            flex: 1;
        }

        .field {
            margin-bottom: 12px;
        }

        .field label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 4px;
        }

        .field input, .field textarea, .field select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d9e6;
            border-radius: 6px;
            font-size: 14px;
            background: #fafafa;
            transition: all 0.2s;
        }

        .field input:focus, .field textarea:focus, .field select:focus {
            outline: none;
            border-color: #E86C28;
            background: white;
            box-shadow: 0 0 0 3px rgba(232, 108, 40, 0.1);
        }

        .field textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .checkbox-grid.single {
            grid-template-columns: 1fr;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: #fafafa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
        }

        .checkbox-item:hover {
            background: #fff5f0;
            border-color: #E86C28;
        }

        .checkbox-item.checked {
            background: #fff5f0;
            border-color: #E86C28;
        }

        .checkbox-item input {
            width: 18px;
            height: 18px;
            accent-color: #E86C28;
            cursor: pointer;
        }

        .checkbox-item span {
            font-size: 13px;
            color: #2d3748;
        }

        .radio-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #fafafa;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .radio-item:hover {
            background: #fff5f0;
            border-color: #E86C28;
        }

        .radio-item.checked {
            background: #fff5f0;
            border-color: #E86C28;
        }

        .radio-item input {
            accent-color: #E86C28;
            cursor: pointer;
        }

        .radio-item span {
            font-size: 13px;
        }

        .photo-section {
            margin-top: 12px;
        }

        .photo-input {
            display: none;
        }

        .photo-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: #fafafa;
            border: 2px dashed #E86C28;
            border-radius: 6px;
            color: #E86C28;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-btn:hover {
            background: #fff5f0;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .photo-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            background: #f0f4f8;
            border: 1px solid #e0e0e0;
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .photo-item .remove-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-item input {
            width: 100%;
            padding: 8px;
            border: none;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            background: white;
        }

        .photo-item input:focus {
            outline: none;
            background: #fafafa;
        }

        .photo-limit-info {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .submit-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: white;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 100;
            display: flex;
            gap: 12px;
        }

        .submit-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            background: #E86C28;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            background: #d55a1a;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(232, 108, 40, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .print-btn {
            background: #6c757d;
        }

        .print-btn:hover {
            background: #5a6268;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #E86C28;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay p {
            color: white;
            font-size: 16px;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.success {
            background: #28a745;
        }
    </style>
</head>
<body>
    <header class="header">
        <img src="public/images/logo1.png" alt="Logo 1" style="height:48px;max-width:80px;vertical-align:middle;float:left;margin-right:16px;object-fit:contain;">
        <h1 style="display:inline-block;vertical-align:middle;margin-bottom:0;">DEFESA CIVIL MUNICIPAL</h1>
        <img src="public/images/logo2.png" alt="Logo 2" style="height:48px;max-width:80px;vertical-align:middle;float:right;margin-left:16px;object-fit:contain;">
        <p style="clear:both;">Relatório Simplificado De Atendimento De Ocorrência</p>
    </header>

    <div class="container">
        <form id="reportForm">
            <!-- Cabeçalho -->
            <div class="section">
                <div class="section-title">Identificação</div>
                <div class="row">
                    <div class="field">
                        <label>Data</label>
                        <input type="date" id="data" required>
                    </div>
                    <div class="field">
                        <label>N°</label>
                        <input type="text" id="numero" placeholder="001/2025" required>
                    </div>
                    <div class="field">
                        <label>Horário</label>
                        <input type="time" id="horario" required>
                    </div>
                </div>
            </div>

            <!-- Demanda -->
            <div class="section">
                <div class="section-title">Demanda</div>
                <div class="checkbox-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="Munícipe">
                        <span>Munícipe</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="Poder Judiciário / MP">
                        <span>Poder Judiciário / MP</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="Denúncia">
                        <span>Denúncia</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="Monit. Defesa Civil Mun.">
                        <span>Monit. Defesa Civil Mun.</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="Defesa Civil Est.">
                        <span>Defesa Civil Est.</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="Poder Legislativo">
                        <span>Poder Legislativo</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="Ouvidoria">
                        <span>Ouvidoria</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="Monit. Defesa Civil Est.">
                        <span>Monit. Defesa Civil Est.</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="PGM">
                        <span>PGM</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="demanda" value="Outros">
                        <span>Outros</span>
                    </label>
                </div>
            </div>

            <!-- Solicitação -->
            <div class="section">
                <div class="section-title">Solicitação</div>
                <div class="row">
                    <div class="field" style="flex: 2;">
                        <label>Nome</label>
                        <input type="text" id="solicitanteNome" required>
                    </div>
                    <div class="field" style="flex: 1;">
                        <label>Telefone</label>
                        <input type="tel" id="solicitanteTelefone" placeholder="(00) 00000-0000">
                    </div>
                </div>
                <div class="field">
                    <label>Tipo de Solicitante</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="tipoSolicitante" value="Proprietário/Morador">
                            <span>Proprietário/Morador</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="tipoSolicitante" value="Responsável">
                            <span>Responsável</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="tipoSolicitante" value="Outro">
                            <span>Outro</span>
                        </label>
                    </div>
                </div>
                <div class="field">
                    <label>E-mail</label>
                    <input type="email" id="solicitanteEmail">
                </div>
                <div class="row">
                    <div class="field" style="flex: 3;">
                        <label>Endereço</label>
                        <input type="text" id="endereco" required>
                    </div>
                    <div class="field" style="flex: 1;">
                        <label>Qd</label>
                        <input type="text" id="quadra">
                    </div>
                    <div class="field" style="flex: 1;">
                        <label>Lote</label>
                        <input type="text" id="lote">
                    </div>
                </div>
                <div class="field">
                    <label>Bairro</label>
                    <input type="text" id="bairro" required>
                </div>
            </div>

            <!-- Tipo de Ocorrência -->
            <div class="section">
                <div class="section-title">Tipo de Ocorrência</div>
                <div class="checkbox-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" name="tipoOcorrencia" value="Geológica">
                        <span>Geológica</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="tipoOcorrencia" value="Estrutural">
                        <span>Estrutural</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="tipoOcorrencia" value="Hidrológica">
                        <span>Hidrológica</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="tipoOcorrencia" value="Outras">
                        <span>Outras</span>
                    </label>
                </div>
            </div>

            <!-- Descrição da Edificação -->
            <div class="section">
                <div class="section-title">Descrição da Edificação Vistoriada</div>
                
                <label style="font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 8px; display: block;">TIPO DE EDIFICAÇÃO</label>
                <div class="checkbox-grid" style="margin-bottom: 16px;">
                    <label class="checkbox-item">
                        <input type="checkbox" name="tipoEdificacao" value="Residencial">
                        <span>Residencial</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="tipoEdificacao" value="Comercial">
                        <span>Comercial</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="tipoEdificacao" value="Pública">
                        <span>Pública</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="tipoEdificacao" value="Outras">
                        <span>Outras</span>
                    </label>
                </div>

                <label style="font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 8px; display: block;">ESTRUTURA</label>
                <div class="checkbox-grid" style="margin-bottom: 16px;">
                    <label class="checkbox-item">
                        <input type="checkbox" name="estrutura" value="Alvenaria e concreto">
                        <span>Alvenaria e concreto</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="estrutura" value="Somente alvenaria">
                        <span>Somente alvenaria</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="estrutura" value="Estrutura metálica">
                        <span>Estrutura metálica</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="estrutura" value="Estrutura de madeira/palafita">
                        <span>Estrutura de madeira/palafita</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="estrutura" value="Concreto armado">
                        <span>Concreto armado</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="estrutura" value="Outros">
                        <span>Outros</span>
                    </label>
                </div>

                <label style="font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 8px; display: block;">TIPO DE COBERTURA</label>
                <div class="checkbox-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" name="cobertura" value="Laje">
                        <span>Laje</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="cobertura" value="Telha cerâmica">
                        <span>Telha cerâmica</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="cobertura" value="Metálica/Zinco">
                        <span>Metálica/Zinco</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="cobertura" value="Amianto">
                        <span>Amianto</span>
                    </label>
                </div>
            </div>

            <!-- Manifestações Patológicas -->
            <div class="section">
                <div class="section-title">Manifestações Patológicas</div>
                <div class="checkbox-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" name="patologia" value="Trincas e fissuras">
                        <span>Trincas e fissuras</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="patologia" value="Corrosão de ferragens">
                        <span>Corrosão de ferragens</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="patologia" value="Inclinação/recalques">
                        <span>Inclinação/recalques</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="patologia" value="Infiltração">
                        <span>Infiltração</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="patologia" value="Deterioração de estruturas">
                        <span>Deterioração de estruturas</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="patologia" value="Esquadria(s) emperrada(s)">
                        <span>Esquadria(s) emperrada(s)</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="patologia" value="Desprendimento de revestimento">
                        <span>Desprendimento de revestimento</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="patologia" value="Outras">
                        <span>Outras</span>
                    </label>
                </div>
            </div>

            <!-- Localização das Anomalias -->
            <div class="section">
                <div class="section-title">Localização das Anomalias</div>
                <div class="checkbox-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" name="localizacao" value="Paredes/esquadrias">
                        <span>Paredes/esquadrias</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="localizacao" value="Laje/Teto">
                        <span>Laje/Teto</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="localizacao" value="Vigas">
                        <span>Vigas</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="localizacao" value="Pilares">
                        <span>Pilares</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="localizacao" value="Outros">
                        <span>Outros</span>
                    </label>
                </div>
            </div>

            <!-- Relatório de Vistoria -->
            <div class="section">
                <div class="section-title">Relatório de Vistoria</div>
                <div class="field">
                    <label>Descrição da Vistoria</label>
                    <textarea id="relatorio" rows="5" placeholder="Descreva detalhadamente as condições encontradas durante a vistoria..." required></textarea>
                </div>
                <div class="field">
                    <label>Providências/Encaminhamentos</label>
                    <textarea id="providencias" rows="3" placeholder="Recomendações e encaminhamentos necessários..."></textarea>
                </div>
            </div>

            <!-- Agente Responsável -->
            <div class="section">
                <div class="section-title">Agente Responsável</div>
                <div class="field">
                    <label>Nome do Agente</label>
                    <input type="text" id="agenteNome" required>
                </div>
                <div class="field">
                    <label>Cargo</label>
                    <input type="text" id="agenteCargo" placeholder="Ex: Assessor Executivo de Defesa Civil">
                </div>
                <div class="field">
                    <label>Decreto/Portaria</label>
                    <input type="text" id="agenteDecreto" placeholder="Ex: Decreto N°424/2025">
                </div>
            </div>

            <!-- Fotos -->
            <div class="section">
                <div class="section-title">Relatório Fotográfico</div>
                <div class="photo-section">
                    <label class="photo-btn" for="photoInput">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        Adicionar Fotos
                    </label>
                    <input type="file" id="photoInput" class="photo-input" accept="image/*" multiple capture="environment">
                    <div class="photo-preview" id="photoPreview"></div>
                    <p class="photo-limit-info">Imagens agrupadas em 2x6</p>
                </div>
            </div>
        </form>
    </div>

    <div class="submit-container">
        <button type="button" class="submit-btn" onclick="generatePDF()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="12" y1="18" x2="12" y2="12"/>
                <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
            Gerar Relatório PDF
        </button>
        <button type="button" class="submit-btn print-btn" onclick="sharePDF()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"/>
                <circle cx="6" cy="12" r="3"/>
                <circle cx="18" cy="19" r="3"/>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
            Compartilhar
        </button>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Gerando PDF...</p>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Configurar data e hora atual
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            document.getElementById('data').value = now.toISOString().split('T')[0];
            document.getElementById('horario').value = now.toTimeString().slice(0, 5);
            
            // Toggle visual para checkboxes e radios
            document.querySelectorAll('.checkbox-item, .radio-item').forEach(item => {
                const input = item.querySelector('input');
                input.addEventListener('change', () => {
                    if (input.type === 'checkbox') {
                        item.classList.toggle('checked', input.checked);
                    } else {
                        document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                            radio.closest('.radio-item').classList.remove('checked');
                        });
                        item.classList.add('checked');
                    }
                });
            });
        });

        // Gerenciamento de fotos - removido limite de 4 fotos
        let photos = [];
        
        document.getElementById('photoInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    photos.push({
                        data: event.target.result,
                        description: ''
                    });
                    renderPhotos();
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        });

        function renderPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = photos.map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo.data}" alt="Foto ${index + 1}">
                    <button type="button" class="remove-photo" onclick="removePhoto(${index})">×</button>
                    <input type="text" placeholder="Descrição da foto ${index + 1}" 
                           value="${photo.description}" 
                           onchange="updatePhotoDescription(${index}, this.value)">
                </div>
            `).join('');
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            renderPhotos();
        }

        function updatePhotoDescription(index, value) {
            photos[index].description = value;
        }

        // Obter valores marcados
        function getCheckedValues(name) {
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
                .map(input => input.value);
        }

        function getRadioValue(name) {
            const checked = document.querySelector(`input[name="${name}"]:checked`);
            return checked ? checked.value : '';
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Formatar data
        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        async function generatePDF() {
            const form = document.getElementById('reportForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 10;
                const contentWidth = pageWidth - (margin * 2);
                let y = margin;

                // Cores
                const orange = [232, 108, 40]; // #E86C28
                const blue = [26, 35, 126]; // Azul escuro do exemplo
                const lightGray = [245, 245, 245];
                const borderColor = [200, 200, 200];

                // Helper: Cabeçalho de seção (igual ao site - título laranja com linha embaixo)
                function drawSectionHeader(title, yPos) {
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...orange);
                    doc.text(title.toUpperCase(), margin + 2, yPos + 3);
                    // Linha laranja embaixo
                    doc.setDrawColor(...orange);
                    doc.setLineWidth(0.5);
                    doc.line(margin + 2, yPos + 4, margin + contentWidth - 2, yPos + 4);
                    doc.setTextColor(0, 0, 0);
                    return yPos + 6;
                }

                function drawCheckbox(x, yPos, label, checked, width = 38) {
                    // Garantir que o checkbox não ultrapasse a margem direita
                    const maxX = pageWidth - margin;
                    const safeWidth = Math.min(width - 2, maxX - x - 2);
                    
                    if (safeWidth < 10) return; // Não desenhar se muito pequeno
                    
                    // Desenhar card com borda (laranja se selecionado, cinza se não)
                    doc.setLineWidth(0.3);
                    if (checked) {
                        doc.setDrawColor(...orange);
                        doc.setFillColor(255, 245, 240); // #fff5f0
                    } else {
                        doc.setDrawColor(224, 224, 224); // #e0e0e0
                        doc.setFillColor(250, 250, 250); // #fafafa
                    }
                    doc.rect(x, yPos, safeWidth, 5, 'FD');
                    
                    // Checkbox square
                    const checkboxX = x + 1.5;
                    const checkboxY = yPos + 1;
                    if (checked) {
                        // Quadrado laranja sólido
                        doc.setFillColor(...orange);
                        doc.setDrawColor(...orange);
                        doc.rect(checkboxX, checkboxY, 3, 3, 'F');
                        // Checkmark branco
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(6);
                        doc.setTextColor(255, 255, 255);
                        doc.text('✓', checkboxX + 1.5, checkboxY + 2.3);
                        doc.setTextColor(0, 0, 0);
                    } else {
                        // Quadrado vazio com borda preta
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.2);
                        doc.rect(checkboxX, checkboxY, 3, 3, 'D');
                    }
                    
                    // Texto do label - truncar se necessário
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    const maxTextWidth = safeWidth - 7;
                    let displayLabel = label;
                    while (doc.getTextWidth(displayLabel) > maxTextWidth && displayLabel.length > 3) {
                        displayLabel = displayLabel.slice(0, -1);
                    }
                    if (displayLabel !== label) displayLabel += '..';
                    doc.text(displayLabel, x + 5.5, yPos + 3.5);
                }

                // ========== CABEÇALHO PRINCIPAL (igual ao exemplo com logos) ==========
                const logo1Url = 'public/images/logo1.png';
                const logo2Url = 'public/images/logo2.png';
                
                const headerHeight = 18;
                const logoWidth = 16;
                const logoHeight = 16;
                
                // Área do cabeçalho central (entre as logos)
                const centerX = margin + logoWidth + 2;
                const centerWidth = contentWidth - (logoWidth * 2) - 4;
                
                // Fundo laranja para "DEFESA CIVIL MUNICIPAL"
                doc.setFillColor(...orange);
                doc.rect(centerX, y, centerWidth, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('DEFESA CIVIL MUNICIPAL', centerX + centerWidth / 2, y + 6.5, { align: 'center' });
                
                // Faixa azul para subtítulo
                doc.setFillColor(...blue);
                doc.rect(centerX, y + 10, centerWidth, 6, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Relatório Simplificado De Atendimento De Ocorrência', centerX + centerWidth / 2, y + 14, { align: 'center' });
                
                // Carregar e adicionar logos
                try {
                    const loadImage = (url) => {
                        return new Promise((resolve, reject) => {
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            img.onload = () => resolve(img);
                            img.onerror = reject;
                            img.src = url;
                        });
                    };
                    
                    const [logo1, logo2] = await Promise.all([
                        loadImage(logo1Url),
                        loadImage(logo2Url)
                    ]);
                    
                    // Ajustar proporções para logo1
                    let logo1W = logoWidth, logo1H = logoHeight;
                    if (logo1.width > logo1.height) {
                        logo1H = logoHeight * (logo1.height / logo1.width);
                        logo1W = logoWidth;
                    } else {
                        logo1W = logoWidth * (logo1.width / logo1.height);
                        logo1H = logoHeight;
                    }
                    // Ajustar proporções para logo2
                    let logo2W = logoWidth, logo2H = logoHeight;
                    if (logo2.width > logo2.height) {
                        logo2H = logoHeight * (logo2.height / logo2.width);
                        logo2W = logoWidth;
                    } else {
                        logo2W = logoWidth * (logo2.width / logo2.height);
                        logo2H = logoHeight;
                    }
                    // Centralizar verticalmente
                    const logo1Y = y + (logoHeight - logo1H) / 2;
                    const logo2Y = y + (logoHeight - logo2H) / 2;
                    // Logo SMSPT à esquerda
                    doc.addImage(logo1, 'PNG', margin, logo1Y, logo1W, logo1H);
                    // Logo Defesa Civil à direita
                    doc.addImage(logo2, 'PNG', pageWidth - margin - logo2W, logo2Y, logo2W, logo2H);
                } catch (e) {
                    console.log('Erro ao carregar logos:', e);
                }
                
                y += headerHeight;

                // ========== IDENTIFICAÇÃO (igual ao site - seção com título) ==========
                y += 2;
                y = drawSectionHeader('IDENTIFICAÇÃO', y);
                
                const data = formatDate(document.getElementById('data').value);
                const numero = document.getElementById('numero').value;
                const horario = document.getElementById('horario').value;

                // Campos sem bordas, apenas texto (igual ao site)
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Data:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(data, margin + 15, y + 3.5);
                
                doc.setFont('helvetica', 'bold');
                doc.text('N°:', margin + contentWidth / 3, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(numero, margin + contentWidth / 3 + 10, y + 3.5);
                
                doc.setFont('helvetica', 'bold');
                doc.text('Horário:', margin + (contentWidth * 2 / 3), y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(horario, margin + (contentWidth * 2 / 3) + 18, y + 3.5);
                y += 6;

                // ========== DEMANDA ==========
                y += 2;
                y = drawSectionHeader('DEMANDA', y);
                
                const demandas = getCheckedValues('demanda');
                const demandaOpts = [
                    ['Munícipe', 'Poder Judiciário / MP'],
                    ['Denúncia', 'Monit. Defesa Civil Mun.'],
                    ['Defesa Civil Est.', 'Poder Legislativo'],
                    ['Ouvidoria', 'Monit. Defesa Civil Est.'],
                    ['PGM', 'Outros']
                ];
                
                const demandaGap = 4;
                const demandaCellW = (contentWidth - demandaGap) / 2;
                demandaOpts.forEach(row => {
                    drawCheckbox(margin, y, row[0], demandas.includes(row[0]), demandaCellW);
                    drawCheckbox(margin + demandaCellW + demandaGap, y, row[1], demandas.includes(row[1]), demandaCellW);
                    y += 6;
                });

                // ========== SOLICITAÇÃO ==========
                y += 2;
                y = drawSectionHeader('SOLICITAÇÃO', y);
                
                const solNome = document.getElementById('solicitanteNome').value;
                const solTel = document.getElementById('solicitanteTelefone').value || '';
                const tipoSol = getRadioValue('tipoSolicitante');
                const solEmail = document.getElementById('solicitanteEmail').value || '';
                const endereco = document.getElementById('endereco').value;
                const quadra = document.getElementById('quadra').value || '';
                const lote = document.getElementById('lote').value || '';
                const bairro = document.getElementById('bairro').value;

                // Linha 1: Nome e Telefone
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('Nome:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(solNome, margin + 16, y + 3.5);
                doc.setFont('helvetica', 'bold');
                doc.text('Telefone:', margin + contentWidth * 0.6, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(solTel, margin + contentWidth * 0.6 + 20, y + 3.5);
                y += 5;
                
                const tipoGap = 3;
                const tipoCardW = (contentWidth - tipoGap * 2) / 3;
                const tipoCardH = 5;
                
                // Prop./Morador
                if (tipoSol === 'Proprietário/Morador') {
                    doc.setDrawColor(...orange);
                    doc.setFillColor(255, 245, 240);
                } else {
                    doc.setDrawColor(224, 224, 224);
                    doc.setFillColor(250, 250, 250);
                }
                doc.setLineWidth(0.3);
                doc.rect(margin, y, tipoCardW, tipoCardH, 'FD');
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.2);
                doc.ellipse(margin + 3, y + 2.5, 1.2, 1.2, 'D');
                if (tipoSol === 'Proprietário/Morador') {
                    doc.setFillColor(...orange);
                    doc.ellipse(margin + 3, y + 2.5, 0.6, 0.6, 'F');
                }
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Prop./Morador', margin + 6, y + 3.3);
                
                // Responsável
                const respX = margin + tipoCardW + tipoGap;
                if (tipoSol === 'Responsável') {
                    doc.setDrawColor(...orange);
                    doc.setFillColor(255, 245, 240);
                } else {
                    doc.setDrawColor(224, 224, 224);
                    doc.setFillColor(250, 250, 250);
                }
                doc.setLineWidth(0.3);
                doc.rect(respX, y, tipoCardW, tipoCardH, 'FD');
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.2);
                doc.ellipse(respX + 3, y + 2.5, 1.2, 1.2, 'D');
                if (tipoSol === 'Responsável') {
                    doc.setFillColor(...orange);
                    doc.ellipse(respX + 3, y + 2.5, 0.6, 0.6, 'F');
                }
                doc.text('Responsável', respX + 6, y + 3.3);
                
                // Outro
                const outroX = margin + (tipoCardW + tipoGap) * 2;
                if (tipoSol === 'Outro') {
                    doc.setDrawColor(...orange);
                    doc.setFillColor(255, 245, 240);
                } else {
                    doc.setDrawColor(224, 224, 224);
                    doc.setFillColor(250, 250, 250);
                }
                doc.setLineWidth(0.3);
                doc.rect(outroX, y, tipoCardW, tipoCardH, 'FD');
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.2);
                doc.ellipse(outroX + 3, y + 2.5, 1.2, 1.2, 'D');
                if (tipoSol === 'Outro') {
                    doc.setFillColor(...orange);
                    doc.ellipse(outroX + 3, y + 2.5, 0.6, 0.6, 'F');
                }
                doc.text('Outro', outroX + 6, y + 3.3);
                
                y += tipoCardH + 2;

                // Linha 2: E-mail
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('E-mail:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(solEmail, margin + 16, y + 3.5);
                y += 5;

                // Linha 3: Endereço, Qd, Lote
                doc.setFont('helvetica', 'bold');
                doc.text('Endereço:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(endereco, margin + 22, y + 3.5);
                doc.setFont('helvetica', 'bold');
                doc.text('Qd:', margin + contentWidth * 0.65, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(quadra, margin + contentWidth * 0.65 + 10, y + 3.5);
                doc.setFont('helvetica', 'bold');
                doc.text('Lote:', margin + contentWidth * 0.82, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(lote, margin + contentWidth * 0.82 + 12, y + 3.5);
                y += 5;

                // Linha 4: Bairro
                doc.setFont('helvetica', 'bold');
                doc.text('Bairro:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(bairro, margin + 16, y + 3.5);
                y += 5;

                // ========== TIPO DE OCORRÊNCIA ==========
                y += 2;
                y = drawSectionHeader('TIPO DE OCORRÊNCIA', y);
                
                const ocorrencias = getCheckedValues('tipoOcorrencia');
                const ocorrGap = 3;
                const ocorrCellW = (contentWidth - ocorrGap * 3) / 4;
                ['Geológica', 'Estrutural', 'Hidrológica', 'Outras'].forEach((opt, i) => {
                    drawCheckbox(margin + i * (ocorrCellW + ocorrGap), y, opt, ocorrencias.includes(opt), ocorrCellW);
                });
                y += 6;

                // ========== DESCRIÇÃO DA EDIFICAÇÃO ==========
                y += 2;
                y = drawSectionHeader('DESCRIÇÃO DA EDIFICAÇÃO VISTORIADA', y);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'bold');
                doc.text('TIPO DE EDIFICAÇÃO', margin + 2, y + 3);
                const tiposEdif = getCheckedValues('tipoEdificacao');
                const edifGap = 2;
                const edifCellW = (contentWidth - edifGap * 3) / 4;
                ['Residencial', 'Comercial', 'Pública', 'Outras'].forEach((opt, i) => {
                    drawCheckbox(margin + i * (edifCellW + edifGap), y + 4, opt, tiposEdif.includes(opt), edifCellW);
                });
                y += 10;

                doc.setFont('helvetica', 'bold');
                doc.text('ESTRUTURA', margin + 2, y + 3);
                const estruturas = getCheckedValues('estrutura');
                const estrutOpts = ['Alvenaria e concreto', 'Somente alvenaria', 'Estrutura metálica', 'Estrutura de madeira/palafita', 'Concreto armado', 'Outros'];
                const estrutLabels = ['Alv. e concreto', 'Só alvenaria', 'Estr. metálica', 'Madeira/palafita', 'Conc. armado', 'Outros'];
                const estrutGap = 2;
                const estrutCellW = (contentWidth - estrutGap * 2) / 3;
                // Primeira linha (3 itens)
                estrutLabels.slice(0, 3).forEach((label, i) => {
                    drawCheckbox(margin + i * (estrutCellW + estrutGap), y + 4, label, estruturas.includes(estrutOpts[i]), estrutCellW);
                });
                y += 10;
                // Segunda linha (3 itens)
                estrutLabels.slice(3, 6).forEach((label, i) => {
                    drawCheckbox(margin + i * (estrutCellW + estrutGap), y, label, estruturas.includes(estrutOpts[i + 3]), estrutCellW);
                });
                y += 6;

                doc.setFont('helvetica', 'bold');
                doc.text('TIPO DE COBERTURA', margin + 2, y + 3);
                const coberturas = getCheckedValues('cobertura');
                const cobGap = 2;
                const cobCellW = (contentWidth - cobGap * 3) / 4;
                ['Laje', 'Telha cerâmica', 'Metálica/Zinco', 'Amianto'].forEach((opt, i) => {
                    drawCheckbox(margin + i * (cobCellW + cobGap), y + 4, opt, coberturas.includes(opt), cobCellW);
                });
                y += 10;

                // ========== MANIFESTAÇÕES PATOLÓGICAS ==========
                y += 2;
                y = drawSectionHeader('MANIFESTAÇÕES PATOLÓGICAS', y);
                
                const patologias = getCheckedValues('patologia');
                const patOpts = [
                    ['Trincas e fissuras', 'Corrosão de ferragens'],
                    ['Inclinação/recalques', 'Infiltração'],
                    ['Deterioração de estruturas', 'Esquadria(s) emperrada(s)'],
                    ['Desprendimento de revestimento', 'Outras']
                ];
                const patGap = 4;
                const patCellW = (contentWidth - patGap) / 2;
                patOpts.forEach(row => {
                    row.forEach((opt, i) => {
                        if (opt) drawCheckbox(margin + i * (patCellW + patGap), y, opt, patologias.includes(opt), patCellW);
                    });
                    y += 6;
                });

                // ========== LOCALIZAÇÃO DAS ANOMALIAS ==========
                y += 2;
                y = drawSectionHeader('LOCALIZAÇÃO DAS ANOMALIAS VERIFICADAS', y);
                
                const localizacoes = getCheckedValues('localizacao');
                const locGap = 3;
                const locCellW = (contentWidth - locGap * 2) / 3;
                const locOpts = ['Paredes/esquadrias', 'Laje/Teto', 'Vigas', 'Pilares', 'Outros'];
                // Primeira linha
                locOpts.slice(0, 3).forEach((opt, i) => {
                    drawCheckbox(margin + i * (locCellW + locGap), y, opt, localizacoes.includes(opt), locCellW);
                });
                y += 6;
                // Segunda linha
                locOpts.slice(3, 5).forEach((opt, i) => {
                    drawCheckbox(margin + i * (locCellW + locGap), y, opt, localizacoes.includes(opt), locCellW);
                });
                y += 6;

                // ========== RELATÓRIO DE VISTORIA ==========
                y += 2;
                y = drawSectionHeader('RELATÓRIO DE VISTORIA', y);
                
                const relatorio = document.getElementById('relatorio').value;
                const providencias = document.getElementById('providencias').value;
                
                const espacoAssinatura = 20;
                const espacoRestante = pageHeight - y - margin - espacoAssinatura;
                
                // Dividir espaço entre Relatório e Providências proporcionalmente
                // Se ambos têm conteúdo, dividir igualmente; senão, dar mais espaço para quem tem
                const relatorioTemConteudo = relatorio && relatorio.trim().length > 0;
                const providenciasTemConteudo = providencias && providencias.trim().length > 0;
                
                let alturaRelatorio, alturaProvidencias;
                const espacoParaCampos = espacoRestante - 12; // 12mm para headers e gaps
                
                if (relatorioTemConteudo && providenciasTemConteudo) {
                    alturaRelatorio = espacoParaCampos * 0.5;
                    alturaProvidencias = espacoParaCampos * 0.5;
                } else if (relatorioTemConteudo) {
                    alturaRelatorio = espacoParaCampos * 0.65;
                    alturaProvidencias = espacoParaCampos * 0.35;
                } else if (providenciasTemConteudo) {
                    alturaRelatorio = espacoParaCampos * 0.35;
                    alturaProvidencias = espacoParaCampos * 0.65;
                } else {
                    alturaRelatorio = espacoParaCampos * 0.5;
                    alturaProvidencias = espacoParaCampos * 0.5;
                }
                
                // Garantir alturas mínimas
                alturaRelatorio = Math.max(alturaRelatorio, 12);
                alturaProvidencias = Math.max(alturaProvidencias, 12);
                
                let fontSizeTexto = 7;
                const linhaAltura = 3.5;
                
                // Testar se o conteúdo cabe com fonte 7
                doc.setFontSize(fontSizeTexto);
                let relatorioLines = doc.splitTextToSize(relatorio || '', contentWidth - 4);
                let maxLinhasRelatorio = Math.floor((alturaRelatorio - 4) / linhaAltura);
                
                // Se não cabe, reduzir fonte
                if (relatorioLines.length > maxLinhasRelatorio && relatorioTemConteudo) {
                    fontSizeTexto = 6;
                    doc.setFontSize(fontSizeTexto);
                    relatorioLines = doc.splitTextToSize(relatorio || '', contentWidth - 4);
                    maxLinhasRelatorio = Math.floor((alturaRelatorio - 4) / 3);
                }
                
                doc.setDrawColor(...borderColor);
                doc.rect(margin, y, contentWidth, alturaRelatorio, 'D');
                doc.setFontSize(fontSizeTexto);
                doc.setFont('helvetica', 'normal');
                let relY = y + 4;
                const linhaAlturaAjustada = fontSizeTexto === 6 ? 3 : 3.5;
                relatorioLines.slice(0, maxLinhasRelatorio).forEach(line => {
                    doc.text(line, margin + 2, relY);
                    relY += linhaAlturaAjustada;
                });
                y += alturaRelatorio;

                // ========== PROVIDÊNCIAS ==========
                y += 2;
                y = drawSectionHeader('PROVIDÊNCIAS / ENCAMINHAMENTOS', y);
                
                doc.setFontSize(fontSizeTexto);
                let provLines = doc.splitTextToSize(providencias || '', contentWidth - 4);
                let maxLinhasProv = Math.floor((alturaProvidencias - 4) / linhaAlturaAjustada);
                
                // Se não cabe, reduzir fonte ainda mais
                if (provLines.length > maxLinhasProv && providenciasTemConteudo && fontSizeTexto > 5) {
                    fontSizeTexto = 5;
                    doc.setFontSize(fontSizeTexto);
                    provLines = doc.splitTextToSize(providencias || '', contentWidth - 4);
                    maxLinhasProv = Math.floor((alturaProvidencias - 4) / 2.5);
                }
                
                doc.setDrawColor(...borderColor);
                doc.rect(margin, y, contentWidth, alturaProvidencias, 'D');
                doc.setFontSize(fontSizeTexto);
                doc.setFont('helvetica', 'normal');
                let provY = y + 4;
                const linhaAlturaFinal = fontSizeTexto === 5 ? 2.5 : linhaAlturaAjustada;
                provLines.slice(0, maxLinhasProv).forEach(line => {
                    doc.text(line, margin + 2, provY);
                    provY += linhaAlturaFinal;
                });
                y += alturaProvidencias;

                // ========== ASSINATURA ==========
                y += 3;
                
                const cidade = 'Cidade Ocidental';
                const dataExtenso = new Date(document.getElementById('data').value + 'T12:00:00')
                    .toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`${cidade}, ${dataExtenso}`, margin + 2, y);
                y += 8;

                // Linha de assinatura
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.line(pageWidth / 2 - 40, y, pageWidth / 2 + 40, y);
                y += 4;
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text(document.getElementById('agenteNome').value, pageWidth / 2, y, { align: 'center' });
                y += 3;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text(document.getElementById('agenteCargo').value || 'Agente de Defesa Civil', pageWidth / 2, y, { align: 'center' });
                y += 3;
                doc.text(document.getElementById('agenteDecreto').value || '', pageWidth / 2, y, { align: 'center' });

                // ========== PÁGINA 2: RELATÓRIO FOTOGRÁFICO ==========  
                if (photos.length > 0) {
                    const cols = 2;
                    const rows = 3;
                    const photosPerPage = cols * rows;

                    const imgGap = 5;
                    const imgWidth = (contentWidth - imgGap) / cols;
                    const imgHeight = imgWidth * 0.75;

                    const totalPhotoPages = Math.ceil(photos.length / photosPerPage);

                    for (let page = 0; page < totalPhotoPages; page++) {
                        doc.addPage();
                        y = margin;

                        // Cabeçalho laranja
                        doc.setFillColor(...orange);
                        doc.rect(margin, y, contentWidth, 8, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        const pageLabel = totalPhotoPages > 1 ? ` (${page + 1}/${totalPhotoPages})` : '';
                        doc.text(`RELATÓRIO FOTOGRÁFICO${pageLabel}`, pageWidth / 2, y + 5.5, { align: 'center' });
                        y += 12;

                        doc.setTextColor(0, 0, 0);

                        const startIdx = page * photosPerPage;
                        const endIdx = Math.min(startIdx + photosPerPage, photos.length);

                        for (let i = startIdx; i < endIdx; i++) {
                            const pagePos = i - startIdx;
                            const col = pagePos % cols;
                            const row = Math.floor(pagePos / cols);

                            const x = margin + col * (imgWidth + imgGap);
                            const yPos = y + row * (imgHeight + 18);

                            const photoNum = i + 1;

                            // Título
                            // doc.setFontSize(8);
                            // doc.setFont('helvetica', 'bold');
                            // doc.text(`IMAGEM ${String(photoNum).padStart(2, '0')}`, x + imgWidth / 2, yPos, { align: 'center' });

                            // Borda
                            doc.setDrawColor(...orange);
                            doc.setLineWidth(0.5);
                            doc.rect(x, yPos + 3, imgWidth, imgHeight, 'D');

                            // Foto
                            try {
                                doc.addImage(
                                    photos[i].data,
                                    'JPEG',
                                    x + 1,
                                    yPos + 4,
                                    imgWidth - 2,
                                    imgHeight - 2
                                );
                            } catch (e) {
                                console.error('Erro ao adicionar imagem:', e);
                            }

                            // Descrição
                            if (photos[i].description) {
                                doc.setFontSize(6);
                                doc.setFont('helvetica', 'italic');
                                const descLines = doc.splitTextToSize(photos[i].description, imgWidth - 4);
                                doc.text(descLines[0] || '', x + imgWidth / 2, yPos + imgHeight + 6, { align: 'center' });
                            }
                        }
                    }
                }

                // Salvar PDF
                const fileName = `RVR-DCM-${numero.replace('/', '-')}.pdf`;
                doc.save(fileName);
                
                showToast('PDF gerado com sucesso!', 'success');
                return doc;
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showToast('Erro ao gerar PDF. Tente novamente.', 'error');
            } finally {
                loading.classList.remove('active');
            }
        }

        async function sharePDF() {
            const form = document.getElementById('reportForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 10;
                const contentWidth = pageWidth - (margin * 2);
                let y = margin;

                const orange = [232, 108, 40];
                const blue = [26, 35, 126];
                const borderColor = [200, 200, 200];

                function drawSectionHeader(title, yPos) {
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...orange);
                    doc.text(title.toUpperCase(), margin + 2, yPos + 3);
                    doc.setDrawColor(...orange);
                    doc.setLineWidth(0.5);
                    doc.line(margin + 2, yPos + 4, margin + contentWidth - 2, yPos + 4);
                    doc.setTextColor(0, 0, 0);
                    return yPos + 6;
                }

                function drawCheckbox(x, yPos, label, checked, width = 38) {
                    const maxX = pageWidth - margin;
                    const safeWidth = Math.min(width - 2, maxX - x - 2);
                    
                    if (safeWidth < 10) return;
                    
                    doc.setLineWidth(0.3);
                    if (checked) {
                        doc.setDrawColor(...orange);
                        doc.setFillColor(255, 245, 240);
                    } else {
                        doc.setDrawColor(224, 224, 224);
                        doc.setFillColor(250, 250, 250);
                    }
                    doc.rect(x, yPos, safeWidth, 5, 'FD');
                    
                    const checkboxX = x + 1.5;
                    const checkboxY = yPos + 1;
                    if (checked) {
                        doc.setFillColor(...orange);
                        doc.setDrawColor(...orange);
                        doc.rect(checkboxX, checkboxY, 3, 3, 'F');
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(6);
                        doc.setTextColor(255, 255, 255);
                        doc.text('✓', checkboxX + 1.5, checkboxY + 2.3);
                        doc.setTextColor(0, 0, 0);
                    } else {
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.2);
                        doc.rect(checkboxX, checkboxY, 3, 3, 'D');
                    }
                    
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    const maxTextWidth = safeWidth - 7;
                    let displayLabel = label;
                    while (doc.getTextWidth(displayLabel) > maxTextWidth && displayLabel.length > 3) {
                        displayLabel = displayLabel.slice(0, -1);
                    }
                    if (displayLabel !== label) displayLabel += '..';
                    doc.text(displayLabel, x + 5.5, yPos + 3.5);
                }

                // Dados do formulário
                const data = formatDate(document.getElementById('data').value);
                const numero = document.getElementById('numero').value;
                const horario = document.getElementById('horario').value;
                const demandas = getCheckedValues('demanda');
                const solNome = document.getElementById('solicitanteNome').value;
                const solTel = document.getElementById('solicitanteTelefone').value || '';
                const tipoSol = getRadioValue('tipoSolicitante');
                const solEmail = document.getElementById('solicitanteEmail').value || '';
                const endereco = document.getElementById('endereco').value;
                const quadra = document.getElementById('quadra').value || '';
                const lote = document.getElementById('lote').value || '';
                const bairro = document.getElementById('bairro').value;
                const ocorrencias = getCheckedValues('tipoOcorrencia');
                const tiposEdif = getCheckedValues('tipoEdificacao');
                const estruturas = getCheckedValues('estrutura');
                const coberturas = getCheckedValues('cobertura');
                const patologias = getCheckedValues('patologia');
                const localizacoes = getCheckedValues('localizacao');
                const relatorio = document.getElementById('relatorio').value;
                const providencias = document.getElementById('providencias').value;

                // CABEÇALHO
                const logo1Url = 'public/images/logo1.png';
                const logo2Url = 'public/images/logo2.png';
                
                const headerHeight = 18;
                const logoWidth = 16;
                const logoHeight = 16;
                
                const centerX = margin + logoWidth + 2;
                const centerWidth = contentWidth - (logoWidth * 2) - 4;
                
                doc.setFillColor(...orange);
                doc.rect(centerX, y, centerWidth, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('DEFESA CIVIL MUNICIPAL', centerX + centerWidth / 2, y + 6.5, { align: 'center' });
                
                doc.setFillColor(...blue);
                doc.rect(centerX, y + 10, centerWidth, 6, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Relatório Simplificado De Atendimento De Ocorrência', centerX + centerWidth / 2, y + 14, { align: 'center' });
                
                try {
                    const loadImage = (url) => {
                        return new Promise((resolve, reject) => {
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            img.onload = () => resolve(img);
                            img.onerror = reject;
                            img.src = url;
                        });
                    };
                    
                    const [logo1, logo2] = await Promise.all([
                        loadImage(logo1Url),
                        loadImage(logo2Url)
                    ]);
                    
                    // Ajustar proporções para logo1
                    let logo1W = logoWidth, logo1H = logoHeight;
                    if (logo1.width > logo1.height) {
                        logo1H = logoHeight * (logo1.height / logo1.width);
                        logo1W = logoWidth;
                    } else {
                        logo1W = logoWidth * (logo1.width / logo1.height);
                        logo1H = logoHeight;
                    }
                    // Ajustar proporções para logo2
                    let logo2W = logoWidth, logo2H = logoHeight;
                    if (logo2.width > logo2.height) {
                        logo2H = logoHeight * (logo2.height / logo2.width);
                        logo2W = logoWidth;
                    } else {
                        logo2W = logoWidth * (logo2.width / logo2.height);
                        logo2H = logoHeight;
                    }
                    // Centralizar verticalmente
                    const logo1Y = y + (logoHeight - logo1H) / 2;
                    const logo2Y = y + (logoHeight - logo2H) / 2;
                    // Logo SMSPT à esquerda
                    doc.addImage(logo1, 'PNG', margin, logo1Y, logo1W, logo1H);
                    // Logo Defesa Civil à direita
                    doc.addImage(logo2, 'PNG', pageWidth - margin - logo2W, logo2Y, logo2W, logo2H);
                } catch (e) {
                    console.log('Erro ao carregar logos:', e);
                }
                
                y += headerHeight;

                // IDENTIFICAÇÃO
                y += 2;
                y = drawSectionHeader('IDENTIFICAÇÃO', y);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Data:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(data, margin + 15, y + 3.5);
                doc.setFont('helvetica', 'bold');
                doc.text('N°:', margin + contentWidth / 3, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(numero, margin + contentWidth / 3 + 10, y + 3.5);
                doc.setFont('helvetica', 'bold');
                doc.text('Horário:', margin + (contentWidth * 2 / 3), y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(horario, margin + (contentWidth * 2 / 3) + 18, y + 3.5);
                y += 6;

                // DEMANDA
                y += 2;
                y = drawSectionHeader('DEMANDA', y);
                const demandaOpts = [
                    ['Munícipe', 'Poder Judiciário / MP'],
                    ['Denúncia', 'Monit. Defesa Civil Mun.'],
                    ['Defesa Civil Est.', 'Poder Legislativo'],
                    ['Ouvidoria', 'Monit. Defesa Civil Est.'],
                    ['PGM', 'Outros']
                ];
                const demandaGap = 4;
                const demandaCellW = (contentWidth - demandaGap) / 2;
                demandaOpts.forEach(row => {
                    drawCheckbox(margin, y, row[0], demandas.includes(row[0]), demandaCellW);
                    drawCheckbox(margin + demandaCellW + demandaGap, y, row[1], demandas.includes(row[1]), demandaCellW);
                    y += 6;
                });

                // SOLICITAÇÃO
                y += 2;
                y = drawSectionHeader('SOLICITAÇÃO', y);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('Nome:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(solNome, margin + 16, y + 3.5);
                doc.setFont('helvetica', 'bold');
                doc.text('Telefone:', margin + contentWidth * 0.6, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(solTel, margin + contentWidth * 0.6 + 20, y + 3.5);
                y += 5;
                
                // Radio buttons
                const tipoGap = 3;
                const tipoCardW = (contentWidth - tipoGap * 2) / 3;
                const tipoCardH = 5;
                
                if (tipoSol === 'Proprietário/Morador') {
                    doc.setDrawColor(...orange);
                    doc.setFillColor(255, 245, 240);
                } else {
                    doc.setDrawColor(224, 224, 224);
                    doc.setFillColor(250, 250, 250);
                }
                doc.setLineWidth(0.3);
                doc.rect(margin, y, tipoCardW, tipoCardH, 'FD');
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.2);
                doc.ellipse(margin + 3, y + 2.5, 1.2, 1.2, 'D');
                if (tipoSol === 'Proprietário/Morador') {
                    doc.setFillColor(...orange);
                    doc.ellipse(margin + 3, y + 2.5, 0.6, 0.6, 'F');
                }
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Prop./Morador', margin + 6, y + 3.3);
                
                const respX = margin + tipoCardW + tipoGap;
                if (tipoSol === 'Responsável') {
                    doc.setDrawColor(...orange);
                    doc.setFillColor(255, 245, 240);
                } else {
                    doc.setDrawColor(224, 224, 224);
                    doc.setFillColor(250, 250, 250);
                }
                doc.setLineWidth(0.3);
                doc.rect(respX, y, tipoCardW, tipoCardH, 'FD');
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.2);
                doc.ellipse(respX + 3, y + 2.5, 1.2, 1.2, 'D');
                if (tipoSol === 'Responsável') {
                    doc.setFillColor(...orange);
                    doc.ellipse(respX + 3, y + 2.5, 0.6, 0.6, 'F');
                }
                doc.text('Responsável', respX + 6, y + 3.3);
                
                const outroX = margin + (tipoCardW + tipoGap) * 2;
                if (tipoSol === 'Outro') {
                    doc.setDrawColor(...orange);
                    doc.setFillColor(255, 245, 240);
                } else {
                    doc.setDrawColor(224, 224, 224);
                    doc.setFillColor(250, 250, 250);
                }
                doc.setLineWidth(0.3);
                doc.rect(outroX, y, tipoCardW, tipoCardH, 'FD');
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.2);
                doc.ellipse(outroX + 3, y + 2.5, 1.2, 1.2, 'D');
                if (tipoSol === 'Outro') {
                    doc.setFillColor(...orange);
                    doc.ellipse(outroX + 3, y + 2.5, 0.6, 0.6, 'F');
                }
                doc.text('Outro', outroX + 6, y + 3.3);
                
                y += tipoCardH + 2;

                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('E-mail:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(solEmail, margin + 16, y + 3.5);
                y += 5;

                doc.setFont('helvetica', 'bold');
                doc.text('Endereço:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(endereco, margin + 22, y + 3.5);
                doc.setFont('helvetica', 'bold');
                doc.text('Qd:', margin + contentWidth * 0.65, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(quadra, margin + contentWidth * 0.65 + 10, y + 3.5);
                doc.setFont('helvetica', 'bold');
                doc.text('Lote:', margin + contentWidth * 0.82, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(lote, margin + contentWidth * 0.82 + 12, y + 3.5);
                y += 5;

                doc.setFont('helvetica', 'bold');
                doc.text('Bairro:', margin + 2, y + 3.5);
                doc.setFont('helvetica', 'normal');
                doc.text(bairro, margin + 16, y + 3.5);
                y += 5;

                // TIPO DE OCORRÊNCIA
                y += 2;
                y = drawSectionHeader('TIPO DE OCORRÊNCIA', y);
                const ocorrGap = 3;
                const ocorrCellW = (contentWidth - ocorrGap * 3) / 4;
                ['Geológica', 'Estrutural', 'Hidrológica', 'Outras'].forEach((opt, i) => {
                    drawCheckbox(margin + i * (ocorrCellW + ocorrGap), y, opt, ocorrencias.includes(opt), ocorrCellW);
                });
                y += 6;

                // DESCRIÇÃO DA EDIFICAÇÃO
                y += 2;
                y = drawSectionHeader('DESCRIÇÃO DA EDIFICAÇÃO VISTORIADA', y);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'bold');
                doc.text('TIPO DE EDIFICAÇÃO', margin + 2, y + 3);
                const edifGap = 2;
                const edifCellW = (contentWidth - edifGap * 3) / 4;
                ['Residencial', 'Comercial', 'Pública', 'Outras'].forEach((opt, i) => {
                    drawCheckbox(margin + i * (edifCellW + edifGap), y + 4, opt, tiposEdif.includes(opt), edifCellW);
                });
                y += 10;

                doc.setFont('helvetica', 'bold');
                doc.text('ESTRUTURA', margin + 2, y + 3);
                const estrutOpts = ['Alvenaria e concreto', 'Somente alvenaria', 'Estrutura metálica', 'Estrutura de madeira/palafita', 'Concreto armado', 'Outros'];
                const estrutLabels = ['Alv. e concreto', 'Só alvenaria', 'Estr. metálica', 'Madeira/palafita', 'Conc. armado', 'Outros'];
                const estrutGap = 2;
                const estrutCellW = (contentWidth - estrutGap * 2) / 3;
                estrutLabels.slice(0, 3).forEach((label, i) => {
                    drawCheckbox(margin + i * (estrutCellW + estrutGap), y + 4, label, estruturas.includes(estrutOpts[i]), estrutCellW);
                });
                y += 10;
                estrutLabels.slice(3, 6).forEach((label, i) => {
                    drawCheckbox(margin + i * (estrutCellW + estrutGap), y, label, estruturas.includes(estrutOpts[i + 3]), estrutCellW);
                });
                y += 6;

                doc.setFont('helvetica', 'bold');
                doc.text('TIPO DE COBERTURA', margin + 2, y + 3);
                const cobGap = 2;
                const cobCellW = (contentWidth - cobGap * 3) / 4;
                ['Laje', 'Telha cerâmica', 'Metálica/Zinco', 'Amianto'].forEach((opt, i) => {
                    drawCheckbox(margin + i * (cobCellW + cobGap), y + 4, opt, coberturas.includes(opt), cobCellW);
                });
                y += 10;

                // MANIFESTAÇÕES PATOLÓGICAS
                y += 2;
                y = drawSectionHeader('MANIFESTAÇÕES PATOLÓGICAS', y);
                const patOpts = [
                    ['Trincas e fissuras', 'Corrosão de ferragens'],
                    ['Inclinação/recalques', 'Infiltração'],
                    ['Deterioração de estruturas', 'Esquadria(s) emperrada(s)'],
                    ['Desprendimento de revestimento', 'Outras']
                ];
                const patGap = 4;
                const patCellW = (contentWidth - patGap) / 2;
                patOpts.forEach(row => {
                    row.forEach((opt, i) => {
                        if (opt) drawCheckbox(margin + i * (patCellW + patGap), y, opt, patologias.includes(opt), patCellW);
                    });
                    y += 6;
                });

                // LOCALIZAÇÃO DAS ANOMALIAS
                y += 2;
                y = drawSectionHeader('LOCALIZAÇÃO DAS ANOMALIAS VERIFICADAS', y);
                const locGap = 3;
                const locCellW = (contentWidth - locGap * 2) / 3;
                const locOpts = ['Paredes/esquadrias', 'Laje/Teto', 'Vigas', 'Pilares', 'Outros'];
                locOpts.slice(0, 3).forEach((opt, i) => {
                    drawCheckbox(margin + i * (locCellW + locGap), y, opt, localizacoes.includes(opt), locCellW);
                });
                y += 6;
                locOpts.slice(3, 5).forEach((opt, i) => {
                    drawCheckbox(margin + i * (locCellW + locGap), y, opt, localizacoes.includes(opt), locCellW);
                });
                y += 6;

                // RELATÓRIO DE VISTORIA
                y += 2;
                y = drawSectionHeader('RELATÓRIO DE VISTORIA', y);
                
                const espacoAssinatura = 20;
                const espacoRestante = pageHeight - y - margin - espacoAssinatura;
                
                // Dividir espaço entre Relatório e Providências proporcionalmente
                const relatorioTemConteudo = relatorio && relatorio.trim().length > 0;
                const providenciasTemConteudo = providencias && providencias.trim().length > 0;
                
                let alturaRelatorio, alturaProvidencias;
                const espacoParaCampos = espacoRestante - 12; // 12mm para headers e gaps
                
                if (relatorioTemConteudo && providenciasTemConteudo) {
                    alturaRelatorio = espacoParaCampos * 0.5;
                    alturaProvidencias = espacoParaCampos * 0.5;
                } else if (relatorioTemConteudo) {
                    alturaRelatorio = espacoParaCampos * 0.65;
                    alturaProvidencias = espacoParaCampos * 0.35;
                } else if (providenciasTemConteudo) {
                    alturaRelatorio = espacoParaCampos * 0.35;
                    alturaProvidencias = espacoParaCampos * 0.65;
                } else {
                    alturaRelatorio = espacoParaCampos * 0.5;
                    alturaProvidencias = espacoParaCampos * 0.5;
                }
                
                alturaRelatorio = Math.max(alturaRelatorio, 12);
                alturaProvidencias = Math.max(alturaProvidencias, 12);
                
                let fontSizeTexto = 7;
                const linhaAltura = 3.5;
                
                doc.setFontSize(fontSizeTexto);
                let relatorioLines = doc.splitTextToSize(relatorio || '', contentWidth - 4);
                let maxLinhasRelatorio = Math.floor((alturaRelatorio - 4) / linhaAltura);
                
                if (relatorioLines.length > maxLinhasRelatorio && relatorioTemConteudo) {
                    fontSizeTexto = 6;
                    doc.setFontSize(fontSizeTexto);
                    relatorioLines = doc.splitTextToSize(relatorio || '', contentWidth - 4);
                    maxLinhasRelatorio = Math.floor((alturaRelatorio - 4) / 3);
                }
                
                doc.setDrawColor(...borderColor);
                doc.rect(margin, y, contentWidth, alturaRelatorio, 'D');
                doc.setFontSize(fontSizeTexto);
                doc.setFont('helvetica', 'normal');
                let relY = y + 4;
                const linhaAlturaAjustada = fontSizeTexto === 6 ? 3 : 3.5;
                relatorioLines.slice(0, maxLinhasRelatorio).forEach(line => {
                    doc.text(line, margin + 2, relY);
                    relY += linhaAlturaAjustada;
                });
                y += alturaRelatorio;

                // PROVIDÊNCIAS
                y += 2;
                y = drawSectionHeader('PROVIDÊNCIAS / ENCAMINHAMENTOS', y);
                
                doc.setFontSize(fontSizeTexto);
                let provLines = doc.splitTextToSize(providencias || '', contentWidth - 4);
                let maxLinhasProv = Math.floor((alturaProvidencias - 4) / linhaAlturaAjustada);
                
                if (provLines.length > maxLinhasProv && providenciasTemConteudo && fontSizeTexto > 5) {
                    fontSizeTexto = 5;
                    doc.setFontSize(fontSizeTexto);
                    provLines = doc.splitTextToSize(providencias || '', contentWidth - 4);
                    maxLinhasProv = Math.floor((alturaProvidencias - 4) / 2.5);
                }
                
                doc.setDrawColor(...borderColor);
                doc.rect(margin, y, contentWidth, alturaProvidencias, 'D');
                doc.setFontSize(fontSizeTexto);
                doc.setFont('helvetica', 'normal');
                let provY = y + 4;
                const linhaAlturaFinal = fontSizeTexto === 5 ? 2.5 : linhaAlturaAjustada;
                provLines.slice(0, maxLinhasProv).forEach(line => {
                    doc.text(line, margin + 2, provY);
                    provY += linhaAlturaFinal;
                });
                y += alturaProvidencias;

                // ASSINATURA
                y += 3;
                
                const cidade = 'Cidade Ocidental';
                const dataExtenso = new Date(document.getElementById('data').value + 'T12:00:00')
                    .toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`${cidade}, ${dataExtenso}`, margin + 2, y);
                y += 8;

                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.line(pageWidth / 2 - 40, y, pageWidth / 2 + 40, y);
                y += 4;
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text(document.getElementById('agenteNome').value, pageWidth / 2, y, { align: 'center' });
                y += 3;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text(document.getElementById('agenteCargo').value || 'Agente de Defesa Civil', pageWidth / 2, y, { align: 'center' });
                y += 3;
                doc.text(document.getElementById('agenteDecreto').value || '', pageWidth / 2, y, { align: 'center' });

                // FOTOS
                if (photos.length > 0) {
                    const cols = 2;
                    const rows = 3;
                    const photosPerPage = cols * rows;
                    const imgGap = 5;
                    const imgWidth = (contentWidth - imgGap) / cols;
                    const imgHeight = imgWidth * 0.75;
                    const totalPhotoPages = Math.ceil(photos.length / photosPerPage);

                    for (let page = 0; page < totalPhotoPages; page++) {
                        doc.addPage();
                        y = margin;

                        doc.setFillColor(...orange);
                        doc.rect(margin, y, contentWidth, 8, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        const pageLabel = totalPhotoPages > 1 ? ` (${page + 1}/${totalPhotoPages})` : '';
                        doc.text(`RELATÓRIO FOTOGRÁFICO${pageLabel}`, pageWidth / 2, y + 5.5, { align: 'center' });
                        y += 12;

                        doc.setTextColor(0, 0, 0);

                        const startIdx = page * photosPerPage;
                        const endIdx = Math.min(startIdx + photosPerPage, photos.length);

                        for (let i = startIdx; i < endIdx; i++) {
                            const pagePos = i - startIdx;
                            const col = pagePos % cols;
                            const row = Math.floor(pagePos / cols);

                            const x = margin + col * (imgWidth + imgGap);
                            const yPos = y + row * (imgHeight + 18);

                            const photoNum = i + 1;

                            // Título
                            // doc.setFontSize(8);
                            // doc.setFont('helvetica', 'bold');
                            // doc.text(`IMAGEM ${String(photoNum).padStart(2, '0')}`, x + imgWidth / 2, yPos, { align: 'center' });

                            // Borda
                            doc.setDrawColor(...orange);
                            doc.setLineWidth(0.5);
                            doc.rect(x, yPos + 3, imgWidth, imgHeight, 'D');

                            // Foto
                            try {
                                doc.addImage(
                                    photos[i].data,
                                    'JPEG',
                                    x + 1,
                                    yPos + 4,
                                    imgWidth - 2,
                                    imgHeight - 2
                                );
                            } catch (e) {
                                console.error('Erro ao adicionar imagem:', e);
                            }

                            // Descrição
                            if (photos[i].description) {
                                doc.setFontSize(6);
                                doc.setFont('helvetica', 'italic');
                                const descLines = doc.splitTextToSize(photos[i].description, imgWidth - 4);
                                doc.text(descLines[0] || '', x + imgWidth / 2, yPos + imgHeight + 6, { align: 'center' });
                            }
                        }
                    }
                }

                const pdfBlob = doc.output('blob');
                const fileName = `RVR-DCM-${numero.replace('/', '-')}.pdf`;
                
                if (navigator.share) {
                    try {
                        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                title: 'Relatório de Vistoria',
                                text: 'Relatório de Vistoria - Defesa Civil',
                                files: [file]
                            });
                            showToast('PDF compartilhado com sucesso!', 'success');
                        } else {
                            const url = URL.createObjectURL(pdfBlob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = fileName;
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast('PDF baixado (compartilhamento não suportado)', 'success');
                        }
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.error('Erro ao compartilhar:', err);
                            showToast('Erro ao compartilhar. PDF será baixado.', 'error');
                            const url = URL.createObjectURL(pdfBlob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = fileName;
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                    }
                } else {
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('PDF baixado (compartilhamento não disponível)', 'success');
                }
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showToast('Erro ao gerar PDF. Tente novamente.', 'error');
            } finally {
                loading.classList.remove('active');
            }
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
